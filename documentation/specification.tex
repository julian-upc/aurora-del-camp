\documentclass[11pt]{amsart}

\usepackage{times}
\usepackage{microtype}
\usepackage{amssymb}
\usepackage{paralist}
\usepackage{url}
\usepackage{a4wide}

\numberwithin{equation}{section}
\newcommand{\ojo}[1]{\textsf{\bfseries\boldmath{#1}}}

\begin{document}

\renewcommand*\descriptionlabel[1]{%
\hspace\labelsep\normalfont\itshape #1:}.

\title{Aurora del Camp -- specification}
\author{Julian Pfeifle}
\date{Version of \today}
\maketitle

This document outlines some of the issues that arise in the
implementation of Gilad's proposal~\cite{buzi11}.

\medskip
Given the availability of powerful free and open source solvers for
integer programs such as CBC~\cite{cbc}, it seems natural to pursue an
integer programming formulation. Of course, free solvers are not as
good as the best commercial ones, but the most recent
benchmarks~\cite{mittelmann11} indicate that CBC is reasonably
competitive; more precisely, it's the most competitive among all
solvers that have an open source license (in the case of CBC, the
``Eclipse Public License'') that permits Gilad to use it commercially
without paying any license fees.

\section{Problem formulation using events}

Here we follow \cite{artigues-etal11}. The resources consumed are time
and money, and money is produced again by selling the crops.

\section{Problem formulation using discrete time}

We start by translating Gilad's document into the language of integer
programs. % Briefly, we want a formulation of the form
% \begin{eqnarray*}
%     \text{minimize} && c\cdot x \\
%     \text{such that} && Ax  \le  b\\
%     && x\in\{0,1\}^n
% \end{eqnarray*}
  
\subsection{Variables}

We work with a set $C$ of crops, the set $W=\{0,\dots,51\}$ of weeks
in the year, and a set $A$ of ``unit lots'', i.e., indivisible units
of farmland dedicated to a single crop or task. The set $A$ has a
distinguished member $a_0\in A$ that stands for off-field work. In
this fictitious area of lot, any number of tasks may be performed
simultaneously, while only one thing at a time may be done in all
lots $A\smallsetminus a_0$. 

We will have several different families of variables, one family for
each specific task. These are further subdivided into families that
only affect the field, and are thus common to all crops, and those
that are specific to each crop.

\begin{description}
\item[Tasks common to all crops]  $ti$~for tilling, $rv$~for
  rotovating, $gm$~for green manure planting, $ft$~for fertilizing,
  $bb$~for bed building, $si$~for setting up irrigation, $sr$ for
  setting rows, $we$ for weeding.

\smallskip
\item[Tasks specific to a crop] $by$ for buying seeds, $ss$ for
  soaking seeds, $cs$ for cutting or separating cloned seeds, $gc$~for
  false germination and cleaning, $pl$~for planting\footnote{We
    consider transplanting and planting to be the same process.},
  $f\!u$ for fumigating, $th$ for thinning, $tr$ for trimming, $co$
  for covering, $ha$~for harvesting.
\end{description}

Each of the ``common'' families contains variables indexed by the
week~$w\in W$ of the year, and the piece of land~$a\in A$. For
instance, the tilling variables are $ti=\{ti_{w,a}:w\in W, a\in
A\}$. The ``crop-specific'' families, on the other hand, contain more
variables, because they also depend on the type of crop $c\in C$. For
example, the set of seed-soaking variables is $ss=\{ss_{c,w,a} : c\in
C, w\in W, a\in A\}$. Each individual variable in each of these
families can take on the value~$0$ or~$1$, depending on whether or not
the task at hand is undertaken for crop~$c$ in the unit lot~$a$
during week~$w$.

With an estimated $40$ types of crops and $40$ unit lots, we get an
upper bound of
\[
   8\times 40\times 52 \text{ (common) }
   \ + \ 
   10\times 40\times 40\times 52 \text{ (specific)}
   \ = \ 
   848\,640 \text{ variables.}
\]
One the one hand, this is well within the reach of commercial solvers
such as Gurobi (we'll have to see how cbc performs, though); on the
other, there will actually be substantially less variables than this
because not all crops need all variables. For example, a crop that is
bought as a seedling from a nursery does not need variables from the
families $by, ss, cs, gc$.

\subsection{Constraints}

To formulate our constraints, we need some additional data on our
crops:
\begin{description}
\item[Plantation interval $pi_{c}$] How many weeks must pass, at
  least, from one planting of crop~$c$ to the next

\item[Yield $y_{c,i}$] The amount of fruit that crop $c$ yields
  $i$~weeks after planting, for $0\le i\le pi_c$.
\end{description}

Now  we can formulate the constraints:

\begin{enumerate}
\item \emph{In each week, there is at most one crop planted at each unit lot:}
\[
   \sum_{c\in C} pl_{c,w,a} \ \le \ 1
   \qquad\text{for all } w\in W \text{ and } a\in A
\]

\item\emph{Respect plantation intervals:}
\begin{equation}\label{eq:pi}
   \sum_{i=w}^{w+pi_c} pl_{c,i,a} \ \le \ 1
   \qquad\text{for all } w\in W, c\in C, a\in A,
\end{equation}
because during any interval of $pi_c$ consecutive weeks, there may
occur at most one planting.  Here and throughout, index additions such
as $i+pi_c$ are understood to be taken modulo 52.

\smallskip
\item\emph{Prescribe the yield:} If we want the total yield of crop~$c$ in
  a given week~$w\in W$ to be $Y_{c,w}$, we must impose
\[
    \sum_{a\in A} \sum_{i=0}^{pi_c} y_{c,i}\; pl_{c,w-i,a}
    \ = \
    Y_{c,w},
\]
because a crop planted $i$ weeks before week $w$ has a yield of
$y_{c,i}$ in week~$w$.  This works because by the foregoing
constraint~\eqref{eq:pi}, at most one of the variables
$\{pl_{c,w-i,a}:0\le i\le pi_c\}$ can have the value~$1$, while the rest must
be~$0$.

\smallskip
\item\emph{Precedence constraints:} Here we must deal with the fact
  that we model our year to be cyclic, i.e., the same 52~weeks repeat
  again and again, as witnessed by our index addition modulo~52 in
  condition~\eqref{eq:pi}. Nevertheless, some tasks must be completed
  before others can start, which implies a linear and not circular
  ordering of time. We model this by interpreting precedence
  constraints to be valid only within a half-year horizon, so
  that \emph{``$x$ must happen before $y$''} is interpreted as meaning
  \emph{``$x$ may not happen until half a year after $y$''}.

%   For example, the constraint that ``tilling'' must happen before ``weeding''
%   is modeled as
%   \[
%      \sum_{i=1}^26 i\cdot ti_{i,c} \ \le \ we_{w,c}
%      \qquad\text{for all } w\in W, c\in C, \text{ and }
%      i\in\{1,\dots,26\}.
%   \]
% \ojo{this is still incorrect}
%   To check this, note that the inequality is not satisfied, for
%   example, if $ti_{4,c}=1$ and $we_{0,c}=1$ (because these variables
%   say we till in week~4, after having weeded in week~0), but is
%   satisfied if $ti_{0,c}=1$ and $we_{4,c}=1$.

\end{enumerate}


\subsection{Objective function}

Each crop $c\in C$ has a yield of  $y_{c,w}$, depending on the week
$w\in W$ it is planted. 
The objective function we want to  maximize is thus
\[
   f 
   \ = \
   \sum_{c\in C, y\in Y} y_{c,w} \sum_{a\in A} x_{c,w,a}
\]

\section{Server-side technology}

Gilad's intention is to make the program available on a server. That's
fine, except that we need to be able to install c++ and cbc on such a server.

\bibliographystyle{siam}
\bibliography{specification}

\end{document}
